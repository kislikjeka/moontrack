openapi: 3.0.3
info:
  title: MoonTrack Portfolio Tracker API
  description: |
    REST API for cryptocurrency portfolio tracking with JWT authentication.

    ## Key Features
    - User registration and authentication
    - Wallet management across multiple blockchains
    - Manual transaction recording (income/outcome)
    - Real-time USD portfolio valuation
    - Historical transaction tracking

    ## Authentication
    All endpoints except `/auth/register` and `/auth/login` require JWT authentication via Bearer token in Authorization header.

  version: 1.0.0
  contact:
    name: MoonTrack Development Team

servers:
  - url: http://localhost:8080/api/v1
    description: Local development server
  - url: https://api.moontrack.example.com/v1
    description: Production server

security:
  - BearerAuth: []

tags:
  - name: Authentication
    description: User registration and login
  - name: Wallets
    description: Wallet management operations
  - name: Transactions
    description: Manual transaction recording
  - name: Portfolio
    description: Portfolio balance and valuation

paths:
  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register new user
      description: Creates a new user account with email and password
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: SecureP@ssw0rd
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid
                    example: 550e8400-e29b-41d4-a716-446655440000
                  email:
                    type: string
                    example: user@example.com
                  token:
                    type: string
                    description: JWT access token
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      description: Authenticates user and returns JWT token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: SecureP@ssw0rd
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid
                  email:
                    type: string
                  token:
                    type: string
                    description: JWT access token
        '401':
          $ref: '#/components/responses/Unauthorized'

  /wallets:
    get:
      tags:
        - Wallets
      summary: List user's wallets
      description: Returns all wallets owned by authenticated user
      responses:
        '200':
          description: List of wallets
          content:
            application/json:
              schema:
                type: object
                properties:
                  wallets:
                    type: array
                    items:
                      $ref: '#/components/schemas/Wallet'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Wallets
      summary: Create new wallet
      description: Creates a new wallet on specified blockchain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - chain_id
              properties:
                name:
                  type: string
                  example: My Main Ethereum Wallet
                  maxLength: 100
                chain_id:
                  type: string
                  enum: [ethereum, bitcoin, solana, polygon, binance-smart-chain, arbitrum, optimism, avalanche]
                  example: ethereum
                address:
                  type: string
                  example: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
                  description: Optional blockchain address for reference
      responses:
        '201':
          description: Wallet created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Wallet'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /wallets/{walletId}:
    get:
      tags:
        - Wallets
      summary: Get wallet details
      description: Returns wallet with current asset balances
      parameters:
        - $ref: '#/components/parameters/WalletId'
      responses:
        '200':
          description: Wallet details
          content:
            application/json:
              schema:
                type: object
                properties:
                  wallet:
                    $ref: '#/components/schemas/Wallet'
                  assets:
                    type: array
                    items:
                      $ref: '#/components/schemas/AssetBalance'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Wallets
      summary: Update wallet
      description: Updates wallet name or address
      parameters:
        - $ref: '#/components/parameters/WalletId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  maxLength: 100
                address:
                  type: string
      responses:
        '200':
          description: Wallet updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Wallet'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Wallets
      summary: Delete wallet
      description: Deletes wallet and all associated accounts (ledger entries are preserved)
      parameters:
        - $ref: '#/components/parameters/WalletId'
      responses:
        '204':
          description: Wallet deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /transactions:
    get:
      tags:
        - Transactions
      summary: List user's transactions
      description: Returns transaction history with pagination
      parameters:
        - name: wallet_id
          in: query
          description: Filter by wallet ID
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          description: Number of transactions to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          description: Number of transactions to skip
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: from_date
          in: query
          description: Filter transactions from this date
          schema:
            type: string
            format: date-time
        - name: to_date
          in: query
          description: Filter transactions until this date
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Transaction list
          content:
            application/json:
              schema:
                type: object
                properties:
                  transactions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
                  total:
                    type: integer
                    description: Total number of transactions
                  limit:
                    type: integer
                  offset:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Transactions
      summary: Create manual transaction
      description: Records a manual income, outcome, or asset adjustment transaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/ManualIncomeRequest'
                - $ref: '#/components/schemas/ManualOutcomeRequest'
                - $ref: '#/components/schemas/AssetAdjustmentRequest'
              discriminator:
                propertyName: transaction_type
      responses:
        '201':
          description: Transaction recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Wallet not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /portfolio:
    get:
      tags:
        - Portfolio
      summary: Get portfolio summary
      description: Returns total portfolio balance and asset breakdown across all wallets
      responses:
        '200':
          description: Portfolio summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_balance_usd:
                    type: string
                    description: Total portfolio value in USD (string to preserve precision)
                    example: "125678.50"
                  assets:
                    type: array
                    items:
                      type: object
                      properties:
                        asset_id:
                          type: string
                          example: BTC
                        total_amount:
                          type: string
                          description: Total amount across all wallets (in base units as string)
                          example: "150000000000000000"
                        display_amount:
                          type: string
                          description: Human-readable amount
                          example: "1.5"
                        display_unit:
                          type: string
                          example: ETH
                        current_price_usd:
                          type: string
                          example: "2345.67"
                        total_value_usd:
                          type: string
                          example: "3518.505"
                        price_updated_at:
                          type: string
                          format: date-time
                  last_updated:
                    type: string
                    format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    WalletId:
      name: walletId
      in: path
      required: true
      description: Wallet UUID
      schema:
        type: string
        format: uuid

  schemas:
    Wallet:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        user_id:
          type: string
          format: uuid
        name:
          type: string
          example: My Main Wallet
        chain_id:
          type: string
          example: ethereum
        address:
          type: string
          nullable: true
          example: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    AssetBalance:
      type: object
      properties:
        asset_id:
          type: string
          example: ETH
        amount:
          type: string
          description: Amount in base units (wei, satoshi, etc.) as string
          example: "1500000000000000000"
        display_amount:
          type: string
          description: Human-readable amount
          example: "1.5"
        display_unit:
          type: string
          example: ETH
        usd_value:
          type: string
          description: Current USD value
          example: "3518.505"
        usd_rate:
          type: string
          description: Current USD price per unit
          example: "2345.67"

    Transaction:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [manual_income, manual_outcome, asset_adjustment]
          example: manual_income
        wallet_id:
          type: string
          format: uuid
        asset_id:
          type: string
          example: BTC
        amount:
          type: string
          description: Amount in base units
          example: "100000000"
        display_amount:
          type: string
          example: "1.0"
        usd_value:
          type: string
          example: "45678.90"
        occurred_at:
          type: string
          format: date-time
        recorded_at:
          type: string
          format: date-time
        notes:
          type: string
          nullable: true
        status:
          type: string
          enum: [COMPLETED, FAILED]
        price_source:
          type: string
          enum: [manual, coingecko]
          description: Indicates whether price was manually specified or fetched from API
          example: coingecko

    ManualIncomeRequest:
      type: object
      required:
        - transaction_type
        - wallet_id
        - asset_id
        - amount
      properties:
        transaction_type:
          type: string
          enum: [manual_income]
        wallet_id:
          type: string
          format: uuid
        asset_id:
          type: string
          example: BTC
        amount:
          type: string
          description: Amount in display units (will be converted to base units)
          example: "1.5"
        usd_rate:
          type: string
          description: |
            Optional manual USD rate. If omitted or null, system fetches from CoinGecko API.
            Use this for obscure tokens not listed in CoinGecko or to override API price.
            Price is permanently stored in ledger (immutable per constitution).
          example: "45678.90"
          nullable: true
        occurred_at:
          type: string
          format: date-time
          description: When transaction occurred. Defaults to now if omitted
          nullable: true
        notes:
          type: string
          maxLength: 500
          nullable: true

    ManualOutcomeRequest:
      type: object
      required:
        - transaction_type
        - wallet_id
        - asset_id
        - amount
      properties:
        transaction_type:
          type: string
          enum: [manual_outcome]
        wallet_id:
          type: string
          format: uuid
        asset_id:
          type: string
        amount:
          type: string
          description: Amount in display units
          example: "0.5"
        usd_rate:
          type: string
          nullable: true
        occurred_at:
          type: string
          format: date-time
          nullable: true
        notes:
          type: string
          maxLength: 500
          nullable: true

    AssetAdjustmentRequest:
      type: object
      required:
        - transaction_type
        - wallet_id
        - asset_id
        - new_balance
      properties:
        transaction_type:
          type: string
          enum: [asset_adjustment]
        wallet_id:
          type: string
          format: uuid
        asset_id:
          type: string
        new_balance:
          type: string
          description: New balance in display units
          example: "10.0"
        usd_rate:
          type: string
          nullable: true
        occurred_at:
          type: string
          format: date-time
          nullable: true
        notes:
          type: string
          description: Reason for adjustment
          maxLength: 500

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
          example: Invalid request parameters
        code:
          type: string
          description: Error code for client-side handling
          example: INVALID_INPUT
        details:
          type: object
          description: Additional error details
          nullable: true

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Validation failed"
            code: "INVALID_INPUT"
            details:
              field: "amount"
              message: "must be greater than 0"

    Unauthorized:
      description: Missing or invalid authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Unauthorized"
            code: "AUTH_REQUIRED"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Wallet not found"
            code: "NOT_FOUND"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Internal server error"
            code: "INTERNAL_ERROR"
