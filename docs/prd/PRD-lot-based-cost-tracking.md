# PRD: Lot-Based Cost Basis Tracking

**Status:** Draft
**Date:** 2026-02-07

---

## Problem Statement

При ручном учёте криптопортфеля пользователь вынужден самостоятельно рассчитывать среднюю стоимость активов, PnL по каждой позиции, и прогнозировать результат выхода из LP-пулов. Это трудоёмко, подвержено ошибкам и не масштабируется при росте количества транзакций и аккаунтов.

## Goals

1. Автоматический расчёт cost basis по каждому активу на основе транзакций
2. Автоматический расчёт realized и unrealized PnL
3. Возможность ретроспективной корректировки cost basis пользователем
4. Прозрачный audit trail всех изменений

## Non-Goals (v1)

- LP pool simulation (what-if сценарии выхода из пулов)
- Автоматическое определение связей между transfer_out и transfer_in на разных кошельках
- Поддержка нескольких валют отчётности (только USD)
- Налоговая отчётность по конкретным юрисдикциям

## User Stories

### Cost Basis Tracking

- Как пользователь, я хочу видеть среднюю стоимость каждого актива на каждом аккаунте, чтобы понимать свою точку безубыточности.
- Как пользователь, при swap я хочу чтобы система автоматически создавала запись о приобретении актива с правильной стоимостью.
- Как пользователь, при transfer_in я хочу чтобы система записала рыночную стоимость на момент получения как стоимость приобретения по умолчанию.

### Cost Basis Override

- Как пользователь, я хочу иметь возможность изменить стоимость приобретения для любого входящего трансфера, указав реальную цену покупки.
- Как пользователь, я хочу привязать transfer_in к transfer_out из другого своего аккаунта, чтобы cost basis перенёсся автоматически.
- Как пользователь, я хочу видеть историю изменений cost basis для audit trail.

### PnL Calculation

- Как пользователь, я хочу видеть realized PnL при продаже/обмене активов, рассчитанный по методу FIFO.
- Как пользователь, я хочу видеть unrealized PnL по текущим позициям на основе рыночных цен.
- Как пользователь, я хочу чтобы при изменении cost basis все связанные PnL пересчитывались автоматически.

### Internal Transfers

- Как пользователь, я хочу чтобы перевод между своими аккаунтами не создавал налогового события (PnL = 0).
- Как пользователь, я хочу чтобы при внутреннем переводе cost basis сохранялся.

## Key Decisions

| Решение | Выбор | Обоснование |
|---------|-------|-------------|
| Метод списания | FIFO | Стандарт для большинства юрисдикций, прозрачная логика |
| Хранение PnL в disposal | Не хранить, считать на лету | Исключает рассинхрон при override, проще архитектура |
| Override механизм | Отдельные поля на лоте | Сохраняем автоматическое значение, override рядом |
| WAC | Materialized view поверх лотов | Единый источник правды — лоты |

## Success Metrics

- Cost basis рассчитывается автоматически для 100% swap-транзакций без ручного ввода
- Пользователь может изменить cost basis любого лота и увидеть обновлённый PnL мгновенно
- Все балансы по double-entry сходятся (debit = credit) при любых операциях
