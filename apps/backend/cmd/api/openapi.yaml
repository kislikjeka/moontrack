openapi: 3.0.3
info:
  title: MoonTrack Portfolio Tracker API
  description: |
    REST API for cryptocurrency portfolio tracking with JWT authentication.

    ## Key Features
    - User registration and authentication
    - Wallet management across multiple blockchains
    - Manual transaction recording (income/outcome)
    - Real-time USD portfolio valuation
    - Historical transaction tracking

    ## Authentication
    All endpoints except `/auth/register` and `/auth/login` require JWT authentication via Bearer token in Authorization header.

  version: 1.0.0
  contact:
    name: MoonTrack Development Team

servers:
  - url: http://localhost:8080/api/v1
    description: Local development server
  - url: https://api.moontrack.example.com/v1
    description: Production server

security:
  - BearerAuth: []

tags:
  - name: Authentication
    description: User registration and login
  - name: Wallets
    description: Wallet management operations
  - name: Transactions
    description: Manual transaction recording
  - name: Portfolio
    description: Portfolio balance and valuation
  - name: Assets
    description: Asset search and price lookup

paths:
  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register new user
      description: Creates a new user account with email and password
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  minLength: 8
                  example: SecureP@ssw0rd
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid
                    example: 550e8400-e29b-41d4-a716-446655440000
                  email:
                    type: string
                    example: user@example.com
                  token:
                    type: string
                    description: JWT access token
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login user
      description: Authenticates user and returns JWT token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  format: password
                  example: SecureP@ssw0rd
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid
                  email:
                    type: string
                  token:
                    type: string
                    description: JWT access token
        '401':
          $ref: '#/components/responses/Unauthorized'

  /wallets:
    get:
      tags:
        - Wallets
      summary: List user's wallets
      description: Returns all wallets owned by authenticated user
      responses:
        '200':
          description: List of wallets
          content:
            application/json:
              schema:
                type: object
                properties:
                  wallets:
                    type: array
                    items:
                      $ref: '#/components/schemas/Wallet'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Wallets
      summary: Create new wallet
      description: Creates a new wallet on specified blockchain
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - chain_id
              properties:
                name:
                  type: string
                  example: My Main Ethereum Wallet
                  maxLength: 100
                chain_id:
                  type: string
                  enum: [ethereum, bitcoin, solana, polygon, binance-smart-chain, arbitrum, optimism, avalanche]
                  example: ethereum
                address:
                  type: string
                  example: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
                  description: Optional blockchain address for reference
      responses:
        '201':
          description: Wallet created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Wallet'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /wallets/{walletId}:
    get:
      tags:
        - Wallets
      summary: Get wallet details
      description: Returns wallet with current asset balances
      parameters:
        - $ref: '#/components/parameters/WalletId'
      responses:
        '200':
          description: Wallet details
          content:
            application/json:
              schema:
                type: object
                properties:
                  wallet:
                    $ref: '#/components/schemas/Wallet'
                  assets:
                    type: array
                    items:
                      $ref: '#/components/schemas/AssetBalance'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Wallets
      summary: Update wallet
      description: Updates wallet name or address
      parameters:
        - $ref: '#/components/parameters/WalletId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  maxLength: 100
                address:
                  type: string
      responses:
        '200':
          description: Wallet updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Wallet'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Wallets
      summary: Delete wallet
      description: Deletes wallet and all associated accounts (ledger entries are preserved)
      parameters:
        - $ref: '#/components/parameters/WalletId'
      responses:
        '204':
          description: Wallet deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /transactions:
    get:
      tags:
        - Transactions
      summary: List user's transactions
      description: Returns transaction history with pagination
      parameters:
        - name: wallet_id
          in: query
          description: Filter by wallet ID
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          description: Number of transactions to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: offset
          in: query
          description: Number of transactions to skip
          schema:
            type: integer
            minimum: 0
            default: 0
        - name: from_date
          in: query
          description: Filter transactions from this date
          schema:
            type: string
            format: date-time
        - name: to_date
          in: query
          description: Filter transactions until this date
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Transaction list
          content:
            application/json:
              schema:
                type: object
                properties:
                  transactions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Transaction'
                  total:
                    type: integer
                    description: Total number of transactions
                  limit:
                    type: integer
                  offset:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags:
        - Transactions
      summary: Create manual transaction
      description: Records a manual income, outcome, or asset adjustment transaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/ManualIncomeRequest'
                - $ref: '#/components/schemas/ManualOutcomeRequest'
                - $ref: '#/components/schemas/AssetAdjustmentRequest'
              discriminator:
                propertyName: transaction_type
      responses:
        '201':
          description: Transaction recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Wallet not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /transactions/{transactionId}:
    get:
      tags:
        - Transactions
      summary: Get transaction details
      description: Returns full transaction details including ledger entries
      parameters:
        - name: transactionId
          in: path
          required: true
          description: Transaction UUID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Transaction details with ledger entries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Transaction not found or unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /assets/search:
    get:
      tags:
        - Assets
      summary: Search cryptocurrency assets
      description: |
        Searches for cryptocurrency assets by name or symbol using CoinGecko API.
        Results are cached for 24 hours and sorted by market cap rank.
        Returns maximum 10 results.
      parameters:
        - name: q
          in: query
          required: true
          description: Search query (min 2, max 50 characters)
          schema:
            type: string
            minLength: 2
            maxLength: 50
          example: BTC
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  assets:
                    type: array
                    items:
                      $ref: '#/components/schemas/SearchAsset'
        '400':
          description: Invalid query parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missing:
                  value:
                    error: "query parameter is required"
                too_short:
                  value:
                    error: "query must be at least 2 characters"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '503':
          description: Search service temporarily unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /assets/{assetId}/price:
    get:
      tags:
        - Assets
      summary: Get current asset price
      description: |
        Returns the current USD price for an asset using its CoinGecko ID.
        Price is returned as a scaled integer (multiplied by 10^8) for precision.
      parameters:
        - name: assetId
          in: path
          required: true
          description: CoinGecko asset ID (e.g., "bitcoin", "ethereum")
          schema:
            type: string
          example: bitcoin
      responses:
        '200':
          description: Asset price
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssetPrice'
        '400':
          description: Invalid asset ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: Asset not found or price unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /portfolio:
    get:
      tags:
        - Portfolio
      summary: Get portfolio summary
      description: Returns total portfolio balance and asset breakdown across all wallets
      responses:
        '200':
          description: Portfolio summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_balance_usd:
                    type: string
                    description: Total portfolio value in USD (string to preserve precision)
                    example: "125678.50"
                  assets:
                    type: array
                    items:
                      type: object
                      properties:
                        asset_id:
                          type: string
                          example: BTC
                        total_amount:
                          type: string
                          description: Total amount across all wallets (in base units as string)
                          example: "150000000000000000"
                        display_amount:
                          type: string
                          description: Human-readable amount
                          example: "1.5"
                        display_unit:
                          type: string
                          example: ETH
                        current_price_usd:
                          type: string
                          example: "2345.67"
                        total_value_usd:
                          type: string
                          example: "3518.505"
                        price_updated_at:
                          type: string
                          format: date-time
                  last_updated:
                    type: string
                    format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    WalletId:
      name: walletId
      in: path
      required: true
      description: Wallet UUID
      schema:
        type: string
        format: uuid

  schemas:
    Wallet:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        user_id:
          type: string
          format: uuid
        name:
          type: string
          example: My Main Wallet
        chain_id:
          type: string
          example: ethereum
        address:
          type: string
          nullable: true
          example: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    AssetBalance:
      type: object
      properties:
        asset_id:
          type: string
          example: ETH
        amount:
          type: string
          description: Amount in base units (wei, satoshi, etc.) as string
          example: "1500000000000000000"
        display_amount:
          type: string
          description: Human-readable amount
          example: "1.5"
        display_unit:
          type: string
          example: ETH
        usd_value:
          type: string
          description: Current USD value
          example: "3518.505"
        usd_rate:
          type: string
          description: Current USD price per unit
          example: "2345.67"

    Transaction:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [manual_income, manual_outcome, asset_adjustment]
          example: manual_income
        type_label:
          type: string
          description: Human-readable type label
          example: "Income"
        wallet_id:
          type: string
          format: uuid
        wallet_name:
          type: string
          description: Wallet name for display
          example: "My Main Wallet"
        asset_id:
          type: string
          example: BTC
        asset_symbol:
          type: string
          description: Asset ticker symbol (uppercase)
          example: "BTC"
        amount:
          type: string
          description: Amount in base units
          example: "100000000"
        display_amount:
          type: string
          description: Human-readable amount with asset symbol
          example: "1.0 BTC"
        direction:
          type: string
          enum: [in, out, adjustment]
          description: Transaction direction for UI display
          example: "in"
        usd_value:
          type: string
          example: "45678.90"
        occurred_at:
          type: string
          format: date-time
        status:
          type: string
          enum: [COMPLETED, FAILED]

    TransactionDetail:
      allOf:
        - $ref: '#/components/schemas/Transaction'
        - type: object
          properties:
            source:
              type: string
              description: Transaction source
              example: "manual"
            external_id:
              type: string
              nullable: true
              description: External transaction ID (e.g., blockchain tx hash)
            recorded_at:
              type: string
              format: date-time
            notes:
              type: string
              nullable: true
            raw_data:
              type: object
              description: Original transaction data for debugging
            entries:
              type: array
              description: Ledger entries for this transaction
              items:
                $ref: '#/components/schemas/LedgerEntry'

    LedgerEntry:
      type: object
      properties:
        id:
          type: string
          format: uuid
        account_code:
          type: string
          description: Account identifier code
          example: "wallet.abc123.btc"
        account_label:
          type: string
          description: Human-readable account label
          example: "My Main Wallet - BTC"
        debit_credit:
          type: string
          enum: [DEBIT, CREDIT]
        entry_type:
          type: string
          enum: [asset_increase, asset_decrease, income, expense, gas_fee]
        amount:
          type: string
          description: Amount in base units
        display_amount:
          type: string
          description: Human-readable amount
        asset_id:
          type: string
        asset_symbol:
          type: string
        usd_value:
          type: string

    ManualIncomeRequest:
      type: object
      required:
        - transaction_type
        - wallet_id
        - asset_id
        - amount
      properties:
        transaction_type:
          type: string
          enum: [manual_income]
        wallet_id:
          type: string
          format: uuid
        asset_id:
          type: string
          example: BTC
        amount:
          type: string
          description: Amount in display units (will be converted to base units)
          example: "1.5"
        usd_rate:
          type: string
          description: |
            Optional manual USD rate. If omitted or null, system fetches from CoinGecko API.
            Use this for obscure tokens not listed in CoinGecko or to override API price.
            Price is permanently stored in ledger (immutable per constitution).
          example: "45678.90"
          nullable: true
        occurred_at:
          type: string
          format: date-time
          description: When transaction occurred. Defaults to now if omitted
          nullable: true
        notes:
          type: string
          maxLength: 500
          nullable: true

    ManualOutcomeRequest:
      type: object
      required:
        - transaction_type
        - wallet_id
        - asset_id
        - amount
      properties:
        transaction_type:
          type: string
          enum: [manual_outcome]
        wallet_id:
          type: string
          format: uuid
        asset_id:
          type: string
        amount:
          type: string
          description: Amount in display units
          example: "0.5"
        usd_rate:
          type: string
          nullable: true
        occurred_at:
          type: string
          format: date-time
          nullable: true
        notes:
          type: string
          maxLength: 500
          nullable: true

    AssetAdjustmentRequest:
      type: object
      required:
        - transaction_type
        - wallet_id
        - asset_id
        - new_balance
      properties:
        transaction_type:
          type: string
          enum: [asset_adjustment]
        wallet_id:
          type: string
          format: uuid
        asset_id:
          type: string
        new_balance:
          type: string
          description: New balance in display units
          example: "10.0"
        usd_rate:
          type: string
          nullable: true
        occurred_at:
          type: string
          format: date-time
          nullable: true
        notes:
          type: string
          description: Reason for adjustment
          maxLength: 500

    SearchAsset:
      type: object
      properties:
        id:
          type: string
          description: CoinGecko asset ID
          example: bitcoin
        symbol:
          type: string
          description: Asset ticker symbol
          example: BTC
        name:
          type: string
          description: Full asset name
          example: Bitcoin
        market_cap_rank:
          type: integer
          description: Market cap ranking (1 = highest)
          example: 1

    AssetPrice:
      type: object
      properties:
        asset_id:
          type: string
          description: CoinGecko asset ID
          example: bitcoin
        price:
          type: string
          description: USD price scaled by 10^8 (for precision)
          example: "4567890000000"
        source:
          type: string
          enum: [coingecko, cache]
          description: Price data source
          example: coingecko
        updated_at:
          type: string
          format: date-time
          description: When the price was last updated
          example: "2026-02-02T12:30:00Z"

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
          example: Invalid request parameters
        code:
          type: string
          description: Error code for client-side handling
          example: INVALID_INPUT
        details:
          type: object
          description: Additional error details
          nullable: true

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Validation failed"
            code: "INVALID_INPUT"
            details:
              field: "amount"
              message: "must be greater than 0"

    Unauthorized:
      description: Missing or invalid authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Unauthorized"
            code: "AUTH_REQUIRED"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Wallet not found"
            code: "NOT_FOUND"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Internal server error"
            code: "INTERNAL_ERROR"
